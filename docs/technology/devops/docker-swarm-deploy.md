---
description: è½»é‡çº§çš„æœåŠ¡éƒ¨ç½² Docker Swarm Deploy Service
---

# è½»é‡çº§çš„æœåŠ¡éƒ¨ç½² Docker Swarm Deploy Service

å¯¹äºå¤§å…¬å¸å¤§é¡¹ç›®ï¼ŒåŠ¨è¾„å‡ åä¸Šç™¾ä¸ªæœåŠ¡ï¼Œä½¿ç”¨ Kubernetes æˆ–è€…äº‘æœåŠ¡æ›´å¥½ã€‚å¯¹äºå°å…¬å¸æˆ–ä¸ªäººé¡¹ç›®ï¼Œä½“é‡å¹¶ä¸ä¼šå¾ˆå¤§ã€‚ä½¿ç”¨ Docker Swarm æ›´åŠ è½»é‡çº§ï¼Œéƒ¨ç½²æ›´åŠ ç®€å•ï¼ŒåŒæ—¶æˆæœ¬ä¹Ÿæ›´ä½ã€‚æˆ‘è‡ªå·±çš„ä¸ªäººé¡¹ç›®å°±åœ¨ä½¿ç”¨ Docker Swarm éƒ¨ç½²ã€‚

## Docker Swarm æ˜¯ä»€ä¹ˆ

`Docker Swarm` æ˜¯ `Docker` å®˜æ–¹æä¾›çš„ä¸€ä¸ªåŸç”Ÿçš„é›†ç¾¤ç®¡ç†å’Œç¼–æ’å·¥å…·ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ª `Docker` ä¸»æœºæŠ½è±¡ä¸ºä¸€ä¸ªè™šæ‹Ÿçš„ `Docker` ä¸»æœºï¼Œä»¥å®ç°å®¹å™¨é›†ç¾¤çš„ç®¡ç†å’Œè°ƒåº¦ã€‚

ä¸ºäº†é«˜æ•ˆç®¡ç†å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºï¼ŒDocker Swarm æä¾›äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

-   **é›†ç¾¤ç®¡ç†**ï¼šæ‚¨å¯ä»¥åˆ›å»ºèŠ‚ç‚¹é›†ç¾¤æ¥ç®¡ç†åº”ç”¨ç¨‹åºå®¹å™¨ã€‚èŠ‚ç‚¹å¯ä»¥æ˜¯ manager æˆ– worker
-   **æœåŠ¡æŠ½è±¡**ï¼šDocker Swarm å¼•å…¥äº†â€œServiceâ€ç»„ä»¶ï¼Œå®ƒå…è®¸æ‚¨è®¾ç½®ç½‘ç»œé…ç½®ã€èµ„æºé™åˆ¶å’Œå®¹å™¨å‰¯æœ¬æ•°é‡ã€‚é€šè¿‡ç®¡ç†æœåŠ¡ï¼ŒDocker Swarm ç¡®ä¿ç»´æŒåº”ç”¨ç¨‹åºæ‰€éœ€çš„çŠ¶æ€
-   **è´Ÿè½½å‡è¡¡**ï¼šSwarm æä¾›å†…ç½®è´Ÿè½½å‡è¡¡ï¼Œå…è®¸é›†ç¾¤å†…çš„æœåŠ¡è¿›è¡Œäº¤äº’ï¼Œè€Œæ— éœ€æ‚¨æ‰‹åŠ¨å®šä¹‰è´Ÿè½½å‡è¡¡å™¨æ–‡ä»¶
-   **å›æ»š**ï¼šåœ¨éƒ¨ç½²å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œå®Œå…¨æ”¯æŒå°†ç‰¹å®šæœåŠ¡å›æ»šåˆ°å…¶å…ˆå‰ç‰ˆæœ¬
-   **å®¹é”™**ï¼šDocker Swarm è‡ªåŠ¨æ£€æŸ¥èŠ‚ç‚¹å’Œå®¹å™¨ä¸­çš„å¤±è´¥é”™è¯¯å¹¶ç”Ÿæˆæ–°çš„å¤±è´¥é”™è¯¯ï¼Œä»¥å…è®¸ç”¨æˆ·ç»§ç»­ä½¿ç”¨åº”ç”¨ç¨‹åºè€Œä¸ä¼šæ³¨æ„åˆ°ä»»ä½•é—®é¢˜
-   **å¯æ‰©å±•æ€§**ï¼šå€ŸåŠ© Docker Swarmï¼Œæ‚¨å¯ä»¥çµæ´»åœ°è½»æ¾è°ƒæ•´å®¹å™¨çš„å‰¯æœ¬æ•°é‡ã€‚è¿™ä½¿æ‚¨å¯ä»¥æ ¹æ®å·¥ä½œè´Ÿè½½ä¸æ–­å˜åŒ–çš„éœ€æ±‚æ¥æ‰©å±•æˆ–ç¼©å°åº”ç”¨ç¨‹åº
-   **é»˜è®¤å®‰å…¨**ï¼šé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¼ºåˆ¶æ‰§è¡Œ TLS ç›¸äº’èº«ä»½éªŒè¯å’ŒåŠ å¯†ï¼Œä»¥ç¡®ä¿å…¶è‡ªèº«ä¸æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡å®‰å…¨ã€‚è¿˜å¯ä»¥é€‰æ‹©ä½¿ç”¨è‡ªç­¾åæ ¹è¯ä¹¦æˆ–æ¥è‡ªè‡ªå®šä¹‰æ ¹ CA çš„è¯ä¹¦ã€‚

## ç¯å¢ƒè¦æ±‚

åªéœ€è¦å®‰è£… `Docker`ï¼Œå®‰è£… `Docker` çš„æ–¹æ³•å¯ä»¥å‚è€ƒ [Docker å®‰è£…](https://docs.docker.com/get-docker/)ã€‚

## æœåŠ¡éƒ¨ç½²

### è¶…ç®€å•çš„æœåŠ¡éƒ¨ç½²

å¯ä»¥å…ˆä¸ç®¡ä¸Šé¢çš„å„ç§æ¦‚å¿µï¼Œå…ˆè·‘èµ·æ¥ã€‚

åˆ›å»ºæ–°çš„ `Swarm` é›†ç¾¤ï¼Œå°† `Docker` åˆ‡æ¢åˆ°é›†ç¾¤æ¨¡å¼ï¼Œ`service` éœ€è¦åœ¨ `Swarm` æ¨¡å¼ä¸‹æ‰èƒ½ä½¿ç”¨ã€‚

```shell
docker swarm init
```

ç„¶åï¼Œä½¿ç”¨ `docker service create` å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„æœåŠ¡

```shell
docker service create --name web --replicas 3 --publish 8080:80 nginx
```

::: details è¿è¡Œç»“æœ

```shell
âœ  ~ docker service create --name web --replicas 3 -p 8080:80 nginx
m3sksh06tl7po97bo4d5tte21
overall progress: 3 out of 3 tasks
1/3: running   [==================================================>]
2/3: running   [==================================================>]
3/3: running   [==================================================>]
verify: Service converged
âœ  ~ docker service ls
ID             NAME      MODE         REPLICAS   IMAGE          PORTS
m3sksh06tl7p   web       replicated   3/3        nginx:latest   *:8080->80/tcp
âœ  ~ docker ps
CONTAINER ID   IMAGE          COMMAND                   CREATED          STATUS          PORTS     NAMES
b9441e6a1239   nginx:latest   "/docker-entrypoint.â€¦"   29 seconds ago   Up 28 seconds   80/tcp    web.2.jlkbj4ybxd52bc9h4dqyh2kst
c3799333bc88   nginx:latest   "/docker-entrypoint.â€¦"   29 seconds ago   Up 28 seconds   80/tcp    web.1.1hx7ihmnzqwz6a2v8rgz5fx16
9c05f8749ab8   nginx:latest   "/docker-entrypoint.â€¦"   29 seconds ago   Up 28 seconds   80/tcp    web.3.33r34ijdvz9bymlyo85v80kz0
```

:::

ğŸ‰ **å®Œæˆéƒ¨ç½²**ã€‚åˆ›å»ºäº†ä¸€ä¸ªåä¸º `web` çš„æœåŠ¡ï¼Œè¯¥æœåŠ¡åŒ…å« 3 ä¸ª `nginx` å‰¯æœ¬ï¼Œå¹¶å°†å®¹å™¨çš„ `80` ç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„ `8080` ç«¯å£ã€‚æœåŠ¡ä¼šè‡ªåŠ¨åœ¨ `Swarm` é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¸Šåˆ›å»ºå®¹å™¨ï¼Œå¹¶è´Ÿè½½å‡è¡¡æµé‡ã€‚

åªéœ€è¦ä¸€ä¸ªå‘½ä»¤ï¼Œä¸€å°æœºå™¨ï¼Œå°±å¯ä»¥å®ŒæˆæœåŠ¡çš„éƒ¨ç½²ã€‚

è®¿é—® `http://localhost:8080` å°±å¯ä»¥çœ‹åˆ° `nginx` çš„æ¬¢è¿é¡µé¢ã€‚

```shell
âœ  ~ curl localhost:8080
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
...truncated...
</html>
```

**æ›´æ–°æœåŠ¡**

ä¸€èˆ¬æ¥è¯´ï¼Œæ›´æ–°æœåŠ¡å°±æ˜¯æ›´æ–°æœ€æ–°é•œåƒ

```shell
docker service update --image nginx:latest web
```

ä¹Ÿå¯ä»¥é…ç½®æ›´å¤šçš„å‚æ•°ï¼Œå¸¸ç”¨çš„æœ‰ï¼š

-   `--replicas`: è®¾ç½®æœåŠ¡çš„å‰¯æœ¬æ•°é‡ï¼Œé»˜è®¤å€¼ä¸º `1`
-   `--update-delay`: æ›´æ–°æœåŠ¡çš„å»¶è¿Ÿæ—¶é—´ï¼Œå•ä½ä¸ºç§’ï¼Œé»˜è®¤å€¼ä¸º `10s`
-   `--update-parallelism`: æ›´æ–°æœåŠ¡çš„å¹¶è¡Œåº¦ï¼Œé»˜è®¤å€¼ä¸º `1`
-   `--update-failure-action`: æ›´æ–°å¤±è´¥æ—¶çš„æ“ä½œï¼Œå¯é€‰å€¼ä¸º `pause`ã€`continue` å’Œ `rollback`ï¼Œé»˜è®¤å€¼ä¸º `pause`
-   `--update-max-failure-ratio`: æ›´æ–°å¤±è´¥çš„æœ€å¤§æ¯”ç‡ï¼Œé»˜è®¤å€¼ä¸º 0ã€‚å¯ä»¥è®¾ç½®è¿™ä¸ªå€¼ä¸ºä»»ä½•åœ¨ 0 å’Œ 1 ä¹‹é—´çš„æµ®ç‚¹æ•°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ è®¾ç½® `--update-max-failure-ratio 0.2`ï¼Œé‚£ä¹ˆå¦‚æœè¶…è¿‡ 20% çš„ä»»åŠ¡å¤±è´¥ï¼Œæ›´æ–°å°±ä¼šè¢«è§†ä¸ºå¤±è´¥ã€‚
-   `--update-monitor`: æ›´æ–°æœåŠ¡çš„ç›‘æ§æ—¶é—´ï¼Œå•ä½ä¸ºç§’ï¼Œé»˜è®¤å€¼ä¸º 5sã€‚æ›´æ–°ä»»åŠ¡åç­‰å¾…å¤šé•¿æ—¶é—´å†å¼€å§‹ç›‘è§†ä»»åŠ¡çš„å¥åº·çŠ¶å†µ

### å¸¸ç”¨çš„æœåŠ¡éƒ¨ç½²

ç®€å•çš„éƒ¨ç½²æ–¹å¼æ˜¯é€šè¿‡å‘½ä»¤è¡Œçš„æ–¹å¼è¿è¡Œï¼Œå¸¸ç”¨çš„æ–¹å¼è¿˜æ˜¯é€šè¿‡ `Docker Compose` æ–‡ä»¶æ¥éƒ¨ç½²æœåŠ¡ã€‚æ¯•ç«Ÿé…ç½®å‚æ•°è¿‡å¤šï¼Œå‘½ä»¤è¡Œä¸æ–¹ä¾¿ï¼Œä¹Ÿå®¹æ˜“å‡ºé”™ã€‚

åˆ›å»ºä¸€ä¸ª `docker-compose.yml` æ–‡ä»¶

```yaml
version: '3'
services:
    web:
        image: nginx
        ports:
            - '8080:80'
        deploy:
            replicas: 3
            update_config:
                parallelism: 1
                delay: 10s
```

ä½¿ç”¨ `docker stack deploy` å‘½ä»¤æ¥éƒ¨ç½²

```shell
docker stack deploy -c docker-compose.yml web
```

::: tip âš ï¸ æ³¨æ„
`Docker Compose` å’Œ `Docker Stack` éƒ½ä½¿ç”¨ `docker-compose.yml` æ–‡ä»¶æ¥å®šä¹‰æœåŠ¡ï¼Œä½†æ˜¯å®ƒä»¬ä¹‹é—´å­˜åœ¨ä¸€äº›å…³é”®çš„å·®å¼‚ã€‚ä¸»è¦åŒºåˆ«åœ¨äº `Docker Compose` ç”¨äºåœ¨å•ä¸ªä¸»æœºä¸Šè¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œè€Œ `Docker Stack` ç”¨äºåœ¨å¤šä¸ªä¸»æœºä¸Šè¿è¡Œå¤šä¸ªå®¹å™¨ã€‚
:::

::: warning âš ï¸ æ³¨æ„
`docker stack` ä½¿ç”¨ `docker-compose.yml` ä¸æ”¯æŒä¾èµ–ï¼Œ`depends_on` ä¸ä¼šç”Ÿæ•ˆã€‚å¦‚æœéœ€è¦ä¾èµ–ï¼Œåªå¯ä»¥ä½¿ç”¨ `docker-compose` æ¥éƒ¨ç½²ã€‚
:::

## æ‰©å®¹

éšç€ä¸šåŠ¡çš„å‘å±•ï¼Œå•å°æœºå™¨çš„æ€§èƒ½å¯èƒ½æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œé€šè¿‡å¢åŠ èŠ‚ç‚¹å’ŒæœåŠ¡çš„å‰¯æœ¬æ•°é‡æ¥æ‰©å®¹ã€‚

### å¢åŠ èŠ‚ç‚¹

é€šè¿‡ `docker swarm join-token` å‘½ä»¤æ¥è·å–åŠ å…¥é›†ç¾¤çš„å‘½ä»¤

```shell
docker swarm join-token worker
```

å°†å‘½ä»¤å¤åˆ¶åˆ°æ–°çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œå°±å¯ä»¥å°†æ–°çš„èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤ä¸­ã€‚

### å¢åŠ æœåŠ¡å‰¯æœ¬

é€šè¿‡ `docker service scale` å‘½ä»¤æ¥å¢åŠ æœåŠ¡çš„å‰¯æœ¬æ•°é‡

```shell
docker service scale web=5
```

::: details è¿è¡Œç»“æœ

```shell
âœ  ~ docker service scale web=5
web scaled to 5
overall progress: 5 out of 5 tasks
1/5: running   [==================================================>]
2/5: running   [==================================================>]
3/5: running   [==================================================>]
4/5: running   [==================================================>]
5/5: running   [==================================================>]
verify: Service converged
âœ  ~ docker service ps web
ID             NAME      IMAGE          NODE       DESIRED STATE   CURRENT STATE           ERROR     PORTS
1hx7ihmnzqwz   web.1     nginx:latest   orbstack   Running         Running 3 hours ago
jlkbj4ybxd52   web.2     nginx:latest   orbstack   Running         Running 3 hours ago
33r34ijdvz9b   web.3     nginx:latest   orbstack   Running         Running 3 hours ago
ydjlrw6qps7y   web.4     nginx:latest   pi2        Running         Running 9 seconds ago
9aqvpy0ocgn7   web.5     nginx:latest   pi2        Running         Running 9 seconds ago
```

æ‰©å®¹å®Œæˆï¼ŒæœåŠ¡çš„å‰¯æœ¬æ•°é‡å˜ä¸º 5ã€‚èƒ½çœ‹åˆ°æ–°çš„èŠ‚ç‚¹ `pi2` ä¸Šä¹Ÿåˆ›å»ºäº† 2 ä¸ªå®¹å™¨ã€‚
:::

## æ€»ç»“

`Docker Swarm` æ˜¯ä¸€ä¸ªè½»é‡çº§çš„æœåŠ¡éƒ¨ç½²å·¥å…·ï¼Œå¯¹äºå°å…¬å¸æˆ–ä¸ªäººé¡¹ç›®æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚åªéœ€è¦ä¸€ä¸ªå‘½ä»¤ï¼Œä¸€å°æœºå™¨ï¼Œå°±å¯ä»¥å®ŒæˆæœåŠ¡çš„éƒ¨ç½²ã€‚åŒæ—¶ï¼Œä¹Ÿæ”¯æŒå¤šèŠ‚ç‚¹ã€å¤šæœåŠ¡ã€è´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½ï¼Œå¯ä»¥æ»¡è¶³ä¸€äº›å°å‹é¡¹ç›®ç”šè‡³æ˜¯ä¸­å¤§é¡¹ç›®çš„éœ€æ±‚ã€‚æˆæœ¬æ›´ä½ï¼Œéƒ¨ç½²æ›´ç®€å•ï¼Œæ²¡å¿…è¦ä¸Š `Kubernetes` æˆ–è€…äº‘æœåŠ¡ã€‚
